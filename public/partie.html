<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partie</title>
    <link rel="stylesheet" href="css/game_style.css" />
</head>
<body>
    <div id="partie">
        <div id="menu">
            <h2>Rejoindre une partie</h2>

            <input id="partieId" placeholder="Nom de la partie" />
            
            <select id="mapSelect">
                <option value="map1">Map 1</option>
                <option value="map2">Map 2</option>
            </select>
            
            <!-- Le for dans le label sert a faire en sorte que quand on appuit sur le texte "Couleur", ca relie au id colorPick et donc ouvre la boite de selection
            <label for="colorPick">Couleur :</label>
            <input id="colorPick" type="color" value="#ff8800" />
            
            <input id="playerPseudo" placeholder="Pseudo" />            -->

            <button id="joinBtn">Rejoindre</button>
      
            <button id="openLogin">Se connecter</button>
            
            <!-- Autre facon de se déplacer avec le href, c'est plus classique et html friendly x)
            <a href="/test-login.html" class="button">Gérer mon compte</a>
            -->
            
            <button id="manageBtn">Gérer mon compte</button> 

            <div id="loginBox" style="display:none; margin-top:10px;">
                <input id="loginIdentifiant" placeholder="identifiant">
                <input id="loginPassword" type="password" placeholder="Mot de passe">
                <button id="doLogin">Valider</button>
                <div id="loginMsg"></div>
            </div>
        </div>
        <canvas id="c" width="800" height="600"></canvas>
    </div>
    


    <script src="/socket.io/socket.io.js"></script>
    <script>
        const canvas = document.getElementById("c");
        const ctx = canvas.getContext("2d");
        canvas.width = 800;
        canvas.height = 600;

        const menu = document.getElementById("menu");
        const joinBtn = document.getElementById("joinBtn");
        const partieInput = document.getElementById("partieId");
        const mapSelect = document.getElementById("mapSelect");
        const manageBtn = document.getElementById("manageBtn");
        //const loginButton = document.getElementById("login")
        //const colorPick = document.getElementById("colorPick");
        //const pseudoInput = document.getElementById("playerPseudo");
       
        const openLogin = document.getElementById("openLogin");
        const loginBox = document.getElementById("loginBox");
        const doLogin = document.getElementById("doLogin");
        const loginMsg = document.getElementById("loginMsg");

        openLogin.onclick = () => {
            loginBox.style.display = 
                loginBox.style.display === "none" ? "block" : "none";
        };

        doLogin.onclick = async () => {
            const identifiant = document.getElementById("loginIdentifiant").value;
            const password = document.getElementById("loginPassword").value;

            const res = await fetch("/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ identifiant, password })
            });

            const data = await res.json();

            if (data.ok) {
                loginMsg.textContent = "Connecté !";
                loginMsg.style.color = "lime";
                //Pour recuperer le vrai userId
                socket.disconnect();
                socket.connect();

                //loginBox.style.display = "none";
            } else {
                loginMsg.textContent = "Identifiants invalides";
                loginMsg.style.color = "red";
            }
        };
        
        manageBtn.addEventListener("click", () => {
            window.location.href = "/test-login.html";
        });

        const socket = io();

        const keys = {
            left: false,
            right: false
        };

        let joueurs = {};
        let colliders =[];
        let exitZone = null;
        let joined =false;
        let joinAlertsDone=false;

        socket.on("connect", () => console.log("Socket.IO connecté", socket.id));
        socket.on("connect_error", (err) => console.error("Erreur connexion", err));

        socket.on("connection_first_on_server", () => {
            if (joinAlertsDone){
                return;
            }
            joinAlertsDone = true;
            alert("Tu es le premier sur ce salon !");
        });

        socket.on("connection_not_first", () => {
            if (joinAlertsDone){
                return;
            }
            joinAlertsDone = true;
            alert("Tu rejoins un salon déjà créer (ce ne sera peut être pas la même map que celle que tu as choisis)!");
        });

        socket.on("join_error", (msg) => {
            if (msg === "not_logged_in"){
                alert("Non connecté. Va te login.");
            }
            else {
                alert("Erreur join: " + msg);
            }
        });

        // Réception des colliders (map) - On attend activement que le serveur envoie
        socket.on("map", (data) => { 
            colliders = data; 
            console.log("[CLIENT] Map reçue:", data);
        });

        // Réception état des joueurs
        socket.on("state", (data) => {
            console.log("[CLIENT] État reçu:", data); 
            joueurs = data;
        });

        socket.on("map", (data) => { 
            colliders = data.colliders;
            exitZone = data.exit; 
            console.log("[CLIENT] Map reçue:", data);
        });

        socket.on("join_success", () => {
            console.log("[CLIENT] Join réussi !");
            menu.style.display = "none";
            canvas.style.display = "block";
            joined = true;
        });

        socket.on("player_exit", () => {
            alert("Vous avez atteint la sortie !");
        });

        // Bouton rejoindre
        joinBtn.addEventListener("click", async() => {
            const partieId = partieInput.value.trim();
            const mapId = mapSelect.value;

            if (!partieId) {
                alert("Entre un nom de partie");
                return;
            }

            socket.emit("join", { 
                partieId, 
                mapId, 
            });

        });
        
        // Actions clavier
        document.addEventListener("keydown", (e) => {
            if (e.repeat) return;

            if (e.key === "ArrowLeft" && !keys.left) {
                  keys.left = true;
                  socket.emit("action", "left");
            }

            if (e.key === "ArrowRight" && !keys.right) {
                keys.right = true;
                socket.emit("action", "right");
            }

            if (e.key === " " || e.key === "ArrowUp") {
                socket.emit("action", "jump");
            }
        });

        document.addEventListener("keyup", (e) => {
            if (e.key === "ArrowLeft") {
                keys.left = false;
                socket.emit("action", "stopLeft");
            }

            if (e.key === "ArrowRight") {
                keys.right = false;
                socket.emit("action", "stopRight");
            }
        });

        // Dessin
        function loop() {
            console.log("[CLIENT] Loop appelée - joined:", joined);
            if (!joined) return requestAnimationFrame(loop);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // dessiner tous les joueurs
            for (const id in joueurs) {
                const p = joueurs[id];
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);
                ctx.fillStyle =  p.colorPlayer || "blue";
                ctx.fillRect(-20, -20, 40, 40);

                ctx.restore();
            }


            // dessiner les colliders
            ctx.fillStyle = "grey";
            for (const c of colliders) {
                ctx.fillRect(
                    c.x - c.width / 2,
                    c.y - c.height / 2,
                    c.width,
                    c.height
                );
            }
            if (exitZone) {
                ctx.fillStyle = "lime"; // Vert fluo pour la sortie
                ctx.fillRect(
                    exitZone.x - exitZone.width / 2,
                    exitZone.y - exitZone.height / 2,
                    exitZone.width,
                    exitZone.height
                );
            }      

            //je le mets pas dans la boucle des joueurs pour qu'on voit les pseudos quand on monte sur un, joueur, quand il y a un rectangle au dessus etc...
            for (const id in joueurs) {
                const p = joueurs[id];
                ctx.save();
                ctx.translate(p.x, p.y);
                // nom au-dessus
                ctx.font = "14px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "bottom";

                // contour : on ecrit le contour du pseudo  (strokeText) en noir en un peu plus gros pour le réecrire en blanc pas dessus pour mieux le voir 
                ctx.lineWidth = 3;
                ctx.strokeStyle = "black";
                ctx.strokeText(p.pseudoPlayer || "", 0, -24); //-24 est juste au dessus du carré  

                ctx.fillStyle = "white";
                ctx.fillText(p.pseudoPlayer || "", 0, -24);
                ctx.restore();
            }

            requestAnimationFrame(loop);
        }

        loop();
    </script>
</body>
</html>
